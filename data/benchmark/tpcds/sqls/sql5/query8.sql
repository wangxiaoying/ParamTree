-- start query 1 in stream 0 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94036','16246','49425','30997','77357','92714',
                          '67721','93450','84644','32373','81863',
                          '48451','37873','14697','83097','75353',
                          '50695','70713','32634','63061','24222',
                          '43798','28020','10986','93213','79756',
                          '88471','80450','81787','55735','97740',
                          '98190','70436','76336','28110','39551',
                          '93955','55401','68308','13683','31545',
                          '32945','96025','15740','19116','58404',
                          '11398','23505','62268','14492','82431',
                          '78472','69894','10465','32552','95878',
                          '77817','32349','83451','64516','62994',
                          '16037','40487','26474','34714','17961',
                          '38132','96820','96553','24866','17103',
                          '11259','29529','95478','52032','51584',
                          '46851','78860','46185','14236','60808',
                          '31114','76098','21565','27998','30015',
                          '29585','37300','72630','16903','60708',
                          '21892','57388','22477','47214','23695',
                          '25320','78514','88544','14259','10212',
                          '62296','71364','31038','55686','29497',
                          '11298','80806','54177','13616','33458',
                          '10215','61432','46288','81164','93788',
                          '31037','28608','79966','69341','53494',
                          '22271','87971','32747','51976','44657',
                          '35674','92100','75031','11164','18547',
                          '29845','36281','98320','60189','55459',
                          '74447','43561','12144','19875','32529',
                          '53540','15226','65219','48592','22062',
                          '78201','36579','77521','63218','55963',
                          '49572','15476','96596','90253','95175',
                          '41446','52795','98533','52739','76969',
                          '19874','82093','51706','36191','22768',
                          '46954','36990','87243','55683','60587',
                          '32383','81051','28904','29221','59045',
                          '63840','45396','30509','30351','26990',
                          '11368','26684','43108','65295','20774',
                          '76540','89838','49939','21235','56305',
                          '40665','16757','24988','39645','20377',
                          '46975','89115','19914','11921','29475',
                          '97328','39503','41854','23531','82067',
                          '35374','68565','23346','12836','20472',
                          '77042','81832','55110','28089','85462',
                          '88920','63367','71929','46066','92088',
                          '82398','32746','29577','82895','40783',
                          '35302','85715','46600','96918','19773',
                          '68213','44861','58355','28748','84358',
                          '88754','61012','47319','24784','63648',
                          '58380','12473','53899','65207','23215',
                          '96166','75541','23848','17993','41772',
                          '35339','71184','69045','49609','42712',
                          '65744','47715','45020','15483','76155',
                          '55897','90484','70901','58705','15175',
                          '66624','42839','50568','54079','19084',
                          '83038','42911','67634','26880','43311',
                          '34694','41195','13174','60767','50935',
                          '12926','52771','42269','26381','70622',
                          '73741','73616','55950','86912','19288',
                          '13969','90114','44166','85698','39849',
                          '80219','95670','54469','94940','29325',
                          '30320','20496','32348','31008','24927',
                          '39978','87634','76324','74642','49835',
                          '15900','40492','95587','47292','20390',
                          '16213','38332','79621','28483','72764',
                          '21464','94725','29309','78601','46517',
                          '81851','53692','92862','49368','29271',
                          '80719','90739','39227','79497','22354',
                          '12624','24801','10929','60860','48026',
                          '98553','63555','10068','24595','19536',
                          '52707','20043','71529','16992','64497',
                          '58472','70672','28123','19453','72091',
                          '58862','48958','71352','96827','16638',
                          '12596','37860','97942','79802','58518',
                          '94264','93469','69325','51928','51425',
                          '48222','97894','71926','29637','39039',
                          '26090','96302','53409','82471','54953',
                          '55690','34612','58660','71944','47995',
                          '40655','14251','77393','38013','57586',
                          '12049','27627','43742','97457','91034',
                          '66959','62102','85514','64814')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 1 in stream 0 using template query8.tpl
